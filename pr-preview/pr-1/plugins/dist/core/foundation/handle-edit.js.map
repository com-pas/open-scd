{"version":3,"file":"handle-edit.js","sourceRoot":"","sources":["../../../../core/foundation/handle-edit.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  EditV2,\n  InsertV2,\n  isComplexV2,\n  isInsertV2,\n  isRemoveV2,\n  isSetAttributesV2,\n  isSetTextContentV2,\n  RemoveV2,\n  SetAttributesV2,\n  SetTextContentV2,\n} from './edit.js';\n\nfunction handleSetTextContent({\n  element,\n  textContent,\n}: SetTextContentV2): (SetTextContentV2 | InsertV2)[] {\n  const { childNodes } = element;\n  \n  const restoreChildNodes: InsertV2[] = Array.from(childNodes).map((node) => ({\n    parent: element,\n    node,\n    reference: null,\n  }));\n  \n  element.textContent = textContent;\n  \n  const undoTextContent: SetTextContentV2 = { element, textContent: '' };\n  \n  return [undoTextContent, ...restoreChildNodes];\n}\n\nfunction uniqueNSPrefix(element: Element, ns: string): string {\n  let i = 1;\n  const attributes = Array.from(element.attributes);\n  const hasSamePrefix = (attribute: Attr) =>\n    attribute.prefix === `ens${i}` && attribute.namespaceURI !== ns;\n  const nsOrNull = new Set([null, ns]);\n  const differentNamespace = (prefix: string) =>\n    !nsOrNull.has(element.lookupNamespaceURI(prefix));\n  while (differentNamespace(`ens${i}`) || attributes.find(hasSamePrefix))\n    i += 1;\n  return `ens${i}`;\n}\n\nconst xmlAttributeName = /^(?!xml|Xml|xMl|xmL|XMl|xML|XmL|XML)[A-Za-z_][A-Za-z0-9-_.]*(:[A-Za-z_][A-Za-z0-9-_.]*)?$/;\n\nfunction validName(name: string): boolean {\n  return xmlAttributeName.test(name);\n}\n\nfunction handleSetAttributes({\n  element,\n  attributes,\n  attributesNS,\n}: SetAttributesV2): SetAttributesV2 {\n  const oldAttributes = { ...attributes };\n  const oldAttributesNS = { ...attributesNS };\n  \n  // save element's non-prefixed attributes for undo\n  Object.keys(attributes)\n    .reverse()\n    .forEach((name) => {\n      oldAttributes[name] = element.getAttribute(name);\n    });\n  \n  // change element's non-prefixed attributes\n  for (const entry of Object.entries(attributes)) {\n    try {\n      const [name, value] = entry as [string, string | null];\n      if (value === null) element.removeAttribute(name);\n      else element.setAttribute(name, value);\n    } catch (_e) {\n      // undo nothing if update didn't work on this attribute\n      delete oldAttributes[entry[0]];\n    }\n  }\n  \n  // save element's namespaced attributes for undo\n  Object.entries(attributesNS).forEach(([ns, attrs]) => {\n    Object.keys(attrs!)\n      .filter(validName)\n      .reverse()\n      .forEach((name) => {\n        oldAttributesNS[ns] = {\n          ...oldAttributesNS[ns],\n          [name]: element.getAttributeNS(ns, name.split(':').pop()!),\n        };\n      });\n      Object.keys(attrs!)\n      .filter((name) => !validName(name))\n      .forEach((name) => {\n        delete oldAttributesNS[ns]![name];\n      });\n  });\n  \n  // change element's namespaced attributes\n  for (const nsEntry of Object.entries(attributesNS)) {\n    const [ns, attrs] = nsEntry as [\n      string,\n      Partial<Record<string, string | null>>,\n    ];\n    for (const entry of Object.entries(attrs).filter(([name]) =>\n      validName(name),\n  )) {\n    try {\n      const [name, value] = entry as [string, string | null];\n      if (value === null) {\n        element.removeAttributeNS(ns, name.split(':').pop()!);\n      } else {\n        let qualifiedName = name;\n        if (!qualifiedName.includes(':')) {\n          let prefix = element.lookupPrefix(ns);\n          if (!prefix) prefix = uniqueNSPrefix(element, ns);\n          qualifiedName = `${prefix}:${name}`;\n        }\n        element.setAttributeNS(ns, qualifiedName, value);\n      }\n    } catch (_e) {\n      delete oldAttributesNS[ns]![entry[0]];\n    }\n  }\n}\n\nreturn {\n  element,\n  attributes: oldAttributes,\n  attributesNS: oldAttributesNS,\n};\n}\n\nfunction handleRemove({ node }: RemoveV2): InsertV2 | [] {\n  const { parentNode: parent, nextSibling: reference } = node;\n  node.parentNode?.removeChild(node);\n  if (parent)\n    return {\n    node,\n    parent,\n    reference,\n  };\n  return [];\n}\n\nfunction handleInsert({\n  parent,\n  node,\n  reference,\n}: InsertV2): InsertV2 | RemoveV2 | [] {\n  try {\n    const { parentNode, nextSibling } = node;\n\n    /**\n     * This is a workaround for converted edit api v1 events,\n     * because if multiple edits are converted, they are converted before the changes from the previous edits are applied to the document\n     * so if you first remove an element and then add a clone with changed attributes, the reference will be the element to remove since it hasnt been removed yet\n     */\n    if (!parent.contains(reference)) {\n      reference = null;\n    }\n\n    parent.insertBefore(node, reference);\n\n    if (parentNode) {\n      // undo: move child node back to original place\n      return {\n        node,\n        parent: parentNode,\n        reference: nextSibling,\n      };\n    }\n\n    // undo: remove orphaned node\n    return { node };\n  } catch (_e) {\n    // undo nothing if insert doesn't work on these nodes\n    return [];\n  }\n}\n\n/** Applies an Edit, returning the corresponding 'undo' Edit. */\nexport function handleEditV2(edit: EditV2): EditV2 {\n  if (isInsertV2(edit)) return handleInsert(edit);\n  if (isRemoveV2(edit)) return handleRemove(edit);\n  if (isSetAttributesV2(edit)) return handleSetAttributes(edit);\n  if (isSetTextContentV2(edit)) return handleSetTextContent(edit);\n  if (isComplexV2(edit)) return edit.map((edit) => handleEditV2(edit)).reverse();\n  \n  return [];\n}\n"]}